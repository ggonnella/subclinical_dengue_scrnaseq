---
title: "InDen T cells | Pseudobulk DESeq2 analysis"
author: "Giorgio Gonnella"
date: 2024-06-13
output:
  html_document:
    theme: sandstone
params:
  pfx: "/srv/baia/"
  libpath: "/home/giorgio/R-pkg-Seurat5/"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message=F, warning=F, echo=T)
.libPaths(c(params$libpath, .libPaths()))

library(Seurat)
library(dplyr)

prj_root <- paste0(params$pfx, "inden/")
analysis_root <- paste0(prj_root, "analysis-1/")

prev_step_dir <- paste0(analysis_root, "steps/008.0.P.T.split_CD8EM/")
input_var_dir <- paste0(prev_step_dir, "results/vars/")

this_step_dir <- paste0(analysis_root, "steps/010.0.P.T.compute_de/")
var_dir <- paste0(this_step_dir, "results/vars/")
dir.create(var_dir, showWarnings = FALSE, recursive = TRUE)
```

```{r load_input_data}
so <- readRDS(file = paste0(input_var_dir, "splitted_CD8EM_so.rds"))
```

```{r prepare_results_slot}
so@misc$de <- list()
```

```{r select_genes}
selgenes <- rownames(so)
print(paste0("Initial number of genes: ", length(selgenes)))

rs <- Matrix::rowSums(so@assays$RNA@counts)
print(summary(rs))
minrowsum = 0
print(paste0("Minimum row sum parameter: ", minrowsum))
selgenes <- rownames(so)[rs >= minrowsum]
print(paste0("Number of selected genes passing rowsum filter: ", length(selgenes)))

TCRgenes <- grep(pattern = "^TR[ABGD][VC]", selgenes, value = TRUE)
print(paste0("Number of TCR genes to filter out: ", length(TCRgenes)))
Ig_genes <- c(grep(pattern = "^IG[HLK][VDJ]", selgenes, value = TRUE),
               c("IGHG1", "IGHD", "IGHE", "IGHA[12]", "IGHG[1234]", "IGKC", "IGLC[1234567]", "AC233755.1"))
print(paste0("Number of IG genes to filter out: ", length(Ig_genes)))
MTgenes <- grep(pattern = "^MT-", selgenes, value = TRUE)
print(paste0("Number of Mitochondrial genes to filter out: ", length(MTgenes)))
RiboGenes <- grep(pattern = "^RP[LS]", selgenes, value = TRUE)
print(paste0("Number of Ribosomal genes to filter out: ", length(RiboGenes)))
MoreGenesToFilter <- c("MALAT1")
print(paste0("Further genes to filter out: ", MoreGenesToFilter))
GenesToFilter = c(TCRgenes, Ig_genes, MTgenes, RiboGenes, MoreGenesToFilter)
print(paste0("Total number of genes to filter out: ", length(GenesToFilter)))

selgenes <- selgenes[!selgenes %in% GenesToFilter]
print(paste0("Final number of selected genes: ", length(selgenes)))
so@misc$de$selgenes <- selgenes
```

```{r prepare_pseudobulk_data}
clusters_col <- "pruned.labels_singleR_fine.mod"
pseudo <- AggregateExpression(so, assays = "RNA", return.seurat = TRUE,
                group.by = c("clinical_condition", "sample", clusters_col))
clusters_data <- pseudo@meta.data[[clusters_col]]
pseudo$cond.clusters <- paste0(pseudo$clinical_condition, "_", clusters_data)
Idents(pseudo) <- "cond.clusters"
cluster_names <- unique(clusters_data)
freqs = table(Idents(pseudo))
```

```{r run_de}
so@misc$de$all <- list()
so@misc$de$pval_filt <- list()

for (cluster in cluster_names) {
  ident.1 <- paste0("Subclinical_", cluster)
  ident.2 <- paste0("Hospitalized_", cluster)
  if ((ident.1 %in% Idents(pseudo)) && (ident.2 %in% Idents(pseudo))
      && (freqs[[ident.1]] > 3) && (freqs[[ident.2]] > 3)) {
    print(paste0("Computing DESeq2 for ", ident.1, " vs ", ident.2, "..."))
    markers <- FindMarkers(pseudo, features = selgenes, logfc.threshold = 0.1,
                 ident.1 = ident.1, ident.2 = ident.2, test.use = "DESeq2")
    so@misc$de$all[[cluster]] <- markers
    so@misc$de$pval_filt[[cluster]] <- markers %>% filter(p_val_adj < 0.05)
    print(paste0("  Number of genes with adj p-value < 0.05: ",
                 nrow(so@misc$de$pval_filt[[cluster]])))
  }
}
```

```{r prepare_pseudobulk_data_unsplitted_CD8EM}
clusters_col2 = "pruned.labels_singleR_fine"
pseudo2 <- AggregateExpression(so, assays = "RNA", return.seurat = TRUE,
                 group.by = c("clinical_condition", "sample", clusters_col2))
clusters_data2 <- pseudo2@meta.data[[clusters_col2]]
pseudo2$cond.clusters <- paste0(pseudo2$clinical_condition, "_", clusters_data2)
Idents(pseudo2) <- "cond.clusters"
freqs2 = table(Idents(pseudo2))
cluster = "Effector memory CD8 T cells"
```

```{r run_de_unsplitted_CD8EM}
ident.1 <- paste0("Subclinical_", cluster)
ident.2 <- paste0("Hospitalized_", cluster)
if ((ident.1 %in% Idents(pseudo2)) && (ident.2 %in% Idents(pseudo2))
    && (freqs2[[ident.1]] > 3) && (freqs2[[ident.2]] > 3)) {
  print(paste0("Computing DESeq2 for ", ident.1, " vs ", ident.2, "..."))
  markers <- FindMarkers(pseudo2, features = selgenes, logfc.threshold = 0.1,
                         ident.1 = ident.1, ident.2 = ident.2, test.use = "DESeq2")
  so@misc$de$all[[cluster]] <- markers
  so@misc$de$pval_filt[[cluster]] <- markers %>% filter(p_val_adj < 0.05)
  print(paste0("  Number of genes with adj p-value < 0.05: ",
               nrow(so@misc$de$pval_filt[[cluster]])))
}
```

```{r prepare_pseudobulk_data_total_cells}
pseudo3 <- AggregateExpression(so, assays = "RNA", return.seurat = TRUE,
                              group.by = c("clinical_condition", "sample"))
Idents(pseudo3) <- "clinical_condition"
freqs3 = table(Idents(pseudo3))
cluster = "Total"
```

```{r run_de_total_cells}
ident.1 <- "Subclinical"
ident.2 <- "Hospitalized"
if ((ident.1 %in% Idents(pseudo3)) && (ident.2 %in% Idents(pseudo3))
    && (freqs3[[ident.1]] > 3) && (freqs3[[ident.2]] > 3)) {
  print(paste0("Computing DESeq2 for ", ident.1, " vs ", ident.2, "..."))
  markers <- FindMarkers(pseudo3, features = selgenes, logfc.threshold = 0.1,
                         ident.1 = ident.1, ident.2 = ident.2, test.use = "DESeq2")
  so@misc$de$all[[cluster]] <- markers
  so@misc$de$pval_filt[[cluster]] <- markers %>% filter(p_val_adj < 0.05)
  print(paste0("  Number of genes with adj p-value < 0.05: ",
               nrow(so@misc$de$pval_filt[[cluster]])))
}
```

```{r save_table, eval=F}
fname <- paste0(results_dir, "so@misc$de$pval_filt.tsv")
cat("cluster\tgene\tperc.1\tperc.2\tp_val\tp_val_adj\tlog2fc\n", file = fname)
for (cluster in c(cluster_names, "Effector memory CD8 T cells", "Total")) {
  for (gene in rownames(so@misc$de$pval_filt[[cluster]][["DESeq2"]])) {
    cat(cluster, "\t", gene, "\t",
        so@misc$de$pval_filt[[cluster]][["DESeq2"]][gene, ]$pct.1, "\t",
        so@misc$de$pval_filt[[cluster]][["DESeq2"]][gene, ]$pct.2, "\t",
        so@misc$de$pval_filt[[cluster]][["DESeq2"]][gene, ]$p_val, "\t",
        so@misc$de$pval_filt[[cluster]][["DESeq2"]][gene, ]$p_val_adj, "\t",
        so@misc$de$pval_filt[[cluster]][["DESeq2"]][gene, ]$avg_log2FC, "\n",
        file = fname, append = TRUE)
  }
  cluster_name_sanitized = gsub(" ", "_", cluster)
  cluster_name_sanitized = gsub("/", "_", cluster_name_sanitized)
  fname_all <- paste0(results_dir, "all_genes.", cluster_name_sanitized,
                      ".", "DESeq2", ".de.tsv")
  data <- so@misc$de$all[[cluster]][["DESeq2"]]
  data$gene <- rownames(data)
  data <- data[, c(ncol(data), 1:(ncol(data) - 1))]
  write.table(data,, file = fname_all, sep = "\t", quote = F, row.names = F)
}
```

```{r save_results}
saveRDS(so, paste0(var_dir, "so_w_deseq.rds"))
```

# Session info

```{r}
sessionInfo()
```

