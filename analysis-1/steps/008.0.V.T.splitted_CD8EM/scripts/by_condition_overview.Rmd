---
title: "Inden Project | T cells | Analysis by condition | Overview"
author: "Giorgio Gonnella"
date: 2024-04-12
output:
  html_document:
    clean: FALSE
    theme: sandstone
params:
  pfx: "/srv/baia/"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE, comment = FALSE, echo = TRUE)


library(Seurat)
library(viridis)
library(ggplot2)
library(ggrepel)
library(ggExtra)
library(gplots)
library(RColorBrewer)
library(reshape2)
library(ggsci)
library(dplyr)
library(scProportionTest)
library(pheatmap)
library(tidyHeatmap)
library(tidyr)
library(tibble)

prj_root <- paste0(params$pfx, "inden/")
analysis_root <- paste0(prj_root, "analysis-1/")

input_step_dir <- paste0(analysis_root, "steps/008.0.P.T.split_CD8EM/")
input_var_dir <- paste0(input_step_dir, "results/vars/")

this_step_dir <- paste0(analysis_root, "steps/008.0.V.T.splitted_CD8EM/")
plots_outdir <- paste0(this_step_dir, "results/plots/")
dir.create(plots_outdir, recursive = T)

gg_scripts_dir <- paste0(prj_root, "helpers/")
source(paste0(gg_scripts_dir, "combined_proportion_plot.R"))
```

```{r load_data, echo=FALSE}
so <- readRDS(file = paste0(input_var_dir, "splitted_CD8EM_so.rds"))

```

## Clinical condition table

```{r clinical_condition, results="asis", echo=F}
print(knitr::kable(table(
        so$clinical_condition)))
cat("\n\n")
print(knitr::kable(as.data.frame.matrix(table(so$sample,
                   so$clinical_condition))))
```

## Clinical condition on UMAP plot

### Overall

```{r, fig.align="center", echo=FALSE, fig.width=12, fig.height=6}
DimPlot(object = so, reduction = "umapharm",
        group.by = "clinical_condition",
        cols = so@misc$cond_cols) +
  ggtitle("UMAP plot, colored by clinical condition")
```

### By sample

```{r, fig.align="center", echo=FALSE, fig.width=12, fig.height=12}
DimPlot(object = so, reduction = "umapharm",
        group.by = "clinical_condition",
        cols = so@misc$cond_cols,
        split.by = "sample", ncol = 3) +
  NoLegend() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "orange1") +
  geom_vline(xintercept = 0, linetype = "dashed", color = "orange1") +
  ggtitle("UMAP plot, colored by condition, splitted by sample")
```

### Phase

```{r phase, echo=F, fig.width=12}
plt <- DimPlot(object = so, reduction = "umapharm",
        group.by = "Phase", split.by = "clinical_condition",
        cols = so@misc$phase_cols) +
  ggtitle("UMAP plot, colored by phase")
fname = paste0(plots_outdir, "umap.by_cond.phase.svg")
ggsave(fname, plot = plt, device = "svg")
plt
```

#### Phase markers

```{r phase_markers1, fig.height=5, fig.width=12, echo=F}
FeaturePlot(so, features = "PCNA",
            reduction = "umapharm", split.by = "clinical_condition",
            shape.by="Phase")
```

```{r phase_markers2, fig.height=5, fig.width=12, echo=F}
FeaturePlot(so, features = "TOP2A",
            reduction = "umapharm", split.by = "clinical_condition",
            shape.by="Phase")
```

```{r phase_markers3, fig.height=5, fig.width=12, echo=F}
FeaturePlot(so, features = "MCM6",
            reduction = "umapharm", split.by = "clinical_condition",
            shape.by="Phase")
```

```{r phase_markers4, fig.height=5, fig.width=12, echo=F}
plt <- FeaturePlot(so, features = "MKI67",
            reduction = "umapharm", split.by = "clinical_condition",
            shape.by="Phase")
fname = paste0(plots_outdir, "phase_marker.MKI67.svg")
ggsave(fname, plot = plt, device = "svg")
plt
```

## Clinical condition and unsupervised clustering

```{r selected_clustering_resolution, echo=F}
g.b = so@misc$sel_res_col
print(paste0("Selected clustering resolution: ",
             so@misc$sel_res))
```

```{r, echo=F}
knitr::kable(table(so$clinical_condition,
      so@meta.data[[g.b]], exclude = NULL))
```

```{r umap_clustering, fig.align="center", fig.width=12, fig.height=6, echo=F}
DimPlot(object = so, reduction = "umapharm",
        group.by = g.b, label = TRUE,
        cols = so@misc$cluster_cols,
        split.by = "clinical_condition")
```

### Sample contributions to clusters

```{r cond_subsets, echo=FALSE}
conditions <- levels(so$clinical_condition)
cond_subset <- list()
for (cond in conditions) {
  cond_subset[[cond]] <- subset(so,
                                subset = clinical_condition == cond)
  cond_subset[[cond]]$sample <- droplevels(cond_subset[[cond]]$sample)
}
```

```{r sample_vs_cl, echo=FALSE, results="asis"}
sample_vs_cl <- list()
for (cond in conditions) {
  subset_table <- table(cond_subset[[cond]]@meta.data[[g.b]],
                        cond_subset[[cond]]$sample)
  cat(paste0("*Condition: ", cond, "*\n\n"))
  print(knitr::kable(subset_table))
  cat("\n\n")
  sample_vs_cl[[cond]] <- as.data.frame(round(prop.table(subset_table, margin=1)*100, digits = 2))
  colnames(sample_vs_cl[[cond]])[1:2] <- c("Cluster", "SampleID")
  levels(sample_vs_cl[[cond]]$Cluster) <- paste("Cl", levels(sample_vs_cl[[cond]]$Cluster), sep = "_")
}
```

```{r sample_vs_cl_plots, fig.width=12, fig.height=6, echo=FALSE}
for (cond in conditions) {
  print(ggplot(sample_vs_cl[[cond]], aes(x = Cluster, y = Freq, fill = SampleID))+
    ggtitle(cond)+
    geom_bar(stat = "identity", alpha = .98)+
    coord_flip()+
    theme_minimal()+
    scale_fill_manual(values = so@misc$sample_cols))
}
```

```{r cl_vs_sample, echo=FALSE, results="asis"}
cl_vs_sample <- list()
for (cond in conditions) {
  subset_table <- table(cond_subset[[cond]]$sample,
                        cond_subset[[cond]]@meta.data[[g.b]])
  cat(paste0("*Condition: ", cond, "*\n\n"))
  print(knitr::kable(subset_table))
  cat("\n\n")
  cl_vs_sample[[cond]] <- as.data.frame(round(prop.table(subset_table, margin=1)*100, digits = 2))
  colnames(cl_vs_sample[[cond]])[1:2] <- c("SampleID", "Cluster")
  levels(cl_vs_sample[[cond]]$Cluster) <- paste("Cl", levels(cl_vs_sample[[cond]]$Cluster), sep = "_")
}
```

```{r cl_vs_sample_plots, fig.width=12, fig.height=6, echo=FALSE}
cols <- so@misc$cluster_cols
names(cols) <- paste0("Cl_", names(so@misc$cluster_cols))
for (cond in conditions) {
  print(ggplot(cl_vs_sample[[cond]], aes(x = SampleID, y = Freq, fill = Cluster))+
    ggtitle(cond)+
    geom_bar(stat = "identity", alpha = .98)+
    coord_flip()+
    theme_minimal()+
    scale_fill_manual(values = cols))
}
```

## Cell types

```{r single_cell_types_umap_post_split, echo=F}
celltype1 <- "Proliferating effector memory CD8 T cells"
celltype2 <- "Non-proliferating effector memory CD8 T cells"
highl1 <- WhichCells(so,
                      expression = pruned.labels_singleR_fine.mod == celltype1)
highl2 <- WhichCells(so,
                      expression = pruned.labels_singleR_fine.mod == celltype2)
plt <- DimPlot(so, reduction = "umapharm",
          cells.highlight = list("Proliferating"=highl1, "Non-prolif."=highl2),
          sizes.highlight = 0.01, pt.size = 0.01,
          cols.highlight = c("darkred", "darkblue"), split.by = "clinical_condition",
          cols = "grey") + ggtitle("Effector memory CD8 T cells") +
       theme(legend.position = "right")
fname = paste0(plots_outdir, "umap.by_cond.effectorCD8_splitted.svg")
ggsave(fname, plot = plt, device = "svg")
plt
```

SingleR fine cell type annotations

```{r singleR_fine.mod_umap, fig.width=12, fig.height=6, echo=F}
plt <- DimPlot(object = so, reduction = "umapharm",
        group.by = "pruned.labels_singleR_fine.mod",
        cols = so@misc$fctype_mod_cols, label = F, repel = TRUE,
        split.by = "clinical_condition")
plt <- plt + ggtitle("T cells subtype assignments by SingleR")
plt <- plt + labs(x = "UMAP Harmony 1", y = "UMAP Harmony 2")
fname = paste0(plots_outdir, "umap.by_cond.singleR_fine.mod.svg")
ggsave(fname, plot = plt, device = "svg")
plt
```

```{r table_fine_celltypes_per_cond, echo=F}
knitr::kable(as.data.frame.matrix(round(prop.table(table(so$clinical_condition,
  so$pruned.labels_singleR_fine.mod), margin = 2)*100, digits = 2)))
```

```{r celltype_df_f_prep, echo=F}
celltype_df_f <- list()
for (cond in conditions) {
  celltype_df_f[[cond]] <- as.data.frame(round(prop.table(table(cond_subset[[cond]]$sample,
                                                              cond_subset[[cond]]$pruned.labels_singleR_fine.mod),
                                                        margin = 2)*100, digits = 2))
  colnames(celltype_df_f[[cond]]) <- c("sample_id", "cell_type", "percentage")
  # remove sample which are not in the current condition
  celltype_df_f[[cond]] <- celltype_df_f[[cond]][celltype_df_f[[cond]]$sample_id %in% unique(cond_subset[[cond]]$sample),]
  celltype_df_f[[cond]]$sample_id <- factor(celltype_df_f[[cond]]$sample_id,
                                            levels = levels(cond_subset[[cond]]$sample))
  #droplevels(celltype_df_f[[cond]]$sample_id)
}
```

```{r celltype_df_f_plots, fig.width=12, fig.height=4, echo=F}
for (cond in conditions) {
  print(ggplot(celltype_df_f[[cond]], aes(x = cell_type, y = percentage))+
    geom_bar(stat = "identity", aes(fill = sample_id))+
    ggtitle(cond)+
    scale_fill_manual(values = so@misc$sample_cols)+
    theme_bw()+
    coord_flip()+
    scale_x_discrete(limits = rev(levels(celltype_df_f[[cond]]$cell_type))))
}
```

```{r table_cond_per_fine_celltypes, echo=F}
knitr::kable(as.data.frame.matrix(round(prop.table(table(
  so$pruned.labels_singleR_fine.mod,
  so$clinical_condition), margin = 2)*100, digits = 2)))
```

```{r celltype_df_fr_prep, echo=F}
celltype_df_fr <- list()
for (cond in conditions) {
  celltype_df_fr[[cond]] <- as.data.frame(round(prop.table(table(
        cond_subset[[cond]]$pruned.labels_singleR_fine.mod,
        cond_subset[[cond]]$sample),
          margin = 2)*100, digits = 2))
  colnames(celltype_df_fr[[cond]]) <- c("cell_type", "sample_id", "percentage")
  # remove sample which are not in the current condition
  celltype_df_fr[[cond]] <- celltype_df_fr[[cond]][celltype_df_fr[[cond]]$sample_id %in% unique(cond_subset[[cond]]$sample),]
  celltype_df_fr[[cond]]$sample_id <- factor(celltype_df_fr[[cond]]$sample_id,
                                            levels = levels(cond_subset[[cond]]$sample))
  #droplevels(celltype_df_fr[[cond]]$sample_id)
}
```

```{r celltype_df_fr_plots, fig.width=12, fig.height=5, echo=F}
for (cond in conditions) {
  print(ggplot(celltype_df_fr[[cond]], aes(x = sample_id, y = percentage))+
    geom_bar(stat = "identity", aes(fill = cell_type))+
    ggtitle(cond)+
    scale_fill_manual(values = so@misc$fctype_mod_cols)+
    theme_bw()+
    coord_flip()+
    scale_x_discrete(limits = rev(levels(celltype_df_fr[[cond]]$sample_id)))) +
    theme(
      plot.margin = margin(t = 50, r = 120, b = 50, l = 10)
    )
}
```

### SingleR labels proportion test

```{r singleR_proportion_test, echo=T}
prop_test <- permutation_test(sc_utils(so),
                              cluster_identity = "pruned.labels_singleR_fine.abbrev",
                              sample_1 = "Subclinical", sample_2 = "Hospitalized",
                              sample_identity = "clinical_condition",
                              n_permutations = 1000)
```

```{r proportion_plot, fig.width=8, fig.height=8, echo=F}
so$cell_group <- NA
for (group in names(so@misc$fctype_group)) {
  so$cell_group <-
    ifelse(so$pruned.labels_singleR_fine %in% so@misc$fctype_group[[group]],
           group, so$cell_group)
}

prop_test@meta_data$cell_group <- NA
for (group in names(so@misc$fctype_group)) {
  prop_test@meta_data$cell_group <-
    ifelse(prop_test@meta_data$pruned.labels_singleR_fine %in% so@misc$fctype_group[[group]],
           group, prop_test@meta_data$cell_group)
}

plt <- grouped_combined_permutation_test_plot(so, prop_test, "pruned.labels_singleR_fine.abbrev", "cell_group", "clinical_condition", "Clinical Condition", so@misc$cond_cols, so@misc$ctg_backcols)
print(plt)
```

```{r}
df_melted <- melt(prop_test@results$permutation,
                  id.vars = "clusters",
                  measure.vars = c("Subclinical", "Hospitalized"),
                  variable.name = "condition",
                  value.name = "proportion")

plt <- ggplot(df_melted, aes(x = clusters, y = condition)) +
  geom_point(aes(size = proportion, color = prop_test@results$permutation$obs_log2FD[prop_test@results$permutation$clusters == clusters]), alpha = 0.8) +
  scale_color_gradient(low = "lightgrey", high = "blue") +
  theme_minimal() +
  labs(title = "Dot Plot of Cell Type Distribution by Condition", x = "Cell Types", y = "Conditions", 
       size = "Proportion", color = "Log2 Fold Change") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
plt
```

```{r}
cell_type_counts <- so@meta.data %>%
  group_by(pruned.labels_singleR_fine.mod, clinical_condition) %>%
  summarise(count = n()) %>%
  ungroup()

total_counts <- cell_type_counts %>%
  group_by(clinical_condition) %>%
  summarise(total = sum(count))

relative_counts <- cell_type_counts %>%
  left_join(total_counts, by = "clinical_condition") %>%
  mutate(relative_count = count / total) %>%
  select(clinical_condition, pruned.labels_singleR_fine.mod, relative_count)

cell_type_counts$pruned.labels_singleR_fine.mod <-
  factor(cell_type_counts$pruned.labels_singleR_fine.mod,
         levels = levels(so$pruned.labels_singleR_fine.mod))
```

```{r}
plt1 <- ggplot(cell_type_counts, aes(x = count, y = pruned.labels_singleR_fine.mod, fill = clinical_condition)) +
  geom_bar(stat = "identity", position = "dodge") +
  theme_minimal() +
  labs(x = "Count", y = "Cell Type", title = "Frequency of Cell Types by Condition") +
  scale_fill_manual(values = so@misc$cond_cols) +
  theme(axis.text.y = element_text(size = 12), 
        axis.text.x = element_text(size = 12), 
        axis.title = element_text(size = 14),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 12))
print(plt1)
```

```{r}
plt2 <- ggplot(relative_counts, aes(x = relative_count, y = pruned.labels_singleR_fine.mod, fill = clinical_condition)) +
  geom_bar(stat = "identity", position = "dodge") +
  theme_minimal() +
  labs(x = "Proportion", y = "Cell Type", title = "Relative Frequency of Cell Types by Condition") +
  scale_fill_manual(values = so@misc$cond_cols) +
  theme(axis.text.y = element_text(size = 12), 
        axis.text.x = element_text(size = 12), 
        axis.title = element_text(size = 14),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 12))
print(plt2)
```

### Heatmap of cell type proportions

```{r}
so$cond_sample <-
  paste0(substr(so$clinical_condition, 1, 4),
         "-", so$sample)
ggData <- as.matrix(prop.table(table(so$pruned.labels_singleR_fine,
                                     so$cond_sample), margin = 2))
plt <- pheatmap(ggData,
         cluster_rows = FALSE, cutree_cols = 2, 
         display_numbers = TRUE, number_format = "%.3f", angle_col = 315,
         width = 4, height = 6)
plt
```

### Single cell types in UMAP

```{r single_cell_types_umap, fig.width=12, fig.height=6, echo=F}
for (celltype in unique(so$pruned.labels_singleR_fine.mod)) {
  highl <- WhichCells(so,
                      expression = pruned.labels_singleR_fine.mod == celltype)
  print(DimPlot(so, reduction = "umapharm",
          cells.highlight = highl, cols.highlight = "darkblue", split.by = "clinical_condition",
          cols = "grey") + ggtitle(celltype) + theme(legend.position = "none"))
}
```

```{r single_cell_types_umap_selected, echo=F}
celltype <- "Effector memory CD8 T cells"
highl <- WhichCells(so,
                      expression = pruned.labels_singleR_fine.mod == celltype)
plt <- DimPlot(so, reduction = "umapharm",
          cells.highlight = highl, cols.highlight = "darkblue", split.by = "clinical_condition",
          cols = "grey") + ggtitle(celltype) + theme(legend.position = "none")
fname = paste0(plots_outdir, "umap.by_cond.effectorCD8.svg")
ggsave(fname, plot = plt, device = "svg")
```

## SingleR vs clustering

```{r singleR_cl_tab1, results="asis", echo=F}
for (cond in conditions) {
  cat(paste0("*Condition: ", cond, "*\n\n"))
  print(knitr::kable(as.data.frame.matrix(
          table(cond_subset[[cond]]@meta.data[[g.b]],
                cond_subset[[cond]]$pruned.labels_singleR_fine.mod))))
  cat("\n\n")
}
```

```{r singleR_cl_tab2, results="asis", echo=F}
for (cond in conditions) {
  cat(paste0("*Condition: ", cond, "*\n\n"))
  print(knitr::kable(as.data.frame.matrix(addmargins(round(prop.table(table(cond_subset[[cond]]@meta.data[[g.b]],
          cond_subset[[cond]]$pruned.labels_singleR_fine.mod), margin = 1)*100, digits = 2), margin = 2))))
  cat("\n\n")
}
```

```{r singleR_cl_tab3, results="asis", echo=F}
for (cond in conditions) {
  cat(paste0("*Condition: ", cond, "*\n\n"))
  print(knitr::kable(as.data.frame.matrix(addmargins(round(prop.table(table(
          cond_subset[[cond]]$pruned.labels_singleR_fine.mod,
          cond_subset[[cond]]@meta.data[[g.b]]), margin = 1)*100, digits = 2), margin = 2))))
  cat("\n\n")
}
```

```{r singleR_cl_df_prep, echo=F}
celltype_df_f <- list()
for (cond in conditions) {
  celltype_df_f[[cond]] <- as.data.frame(round(prop.table(table(cond_subset[[cond]]@meta.data[[g.b]],
                                                              cond_subset[[cond]]$pruned.labels_singleR_fine.mod),
                                                        margin = 2)*100, digits = 2))
  colnames(celltype_df_f[[cond]]) <- c("cluster_id", "cell_type", "percentage")
  # remove cluster which are not in the current condition
  celltype_df_f[[cond]] <- celltype_df_f[[cond]][celltype_df_f[[cond]]$cluster_id %in% unique(cond_subset[[cond]]@meta.data[[g.b]]),]
  celltype_df_f[[cond]]$cluster_id <- factor(celltype_df_f[[cond]]$cluster_id)
}
```

```{r singleR_cl_df_plots, fig.width=12, fig.height=6, echo=F}
for (cond in conditions) {
  print(ggplot(celltype_df_f[[cond]], aes(x = cell_type, y = percentage))+
    geom_bar(stat = "identity", aes(fill = cluster_id))+
    ggtitle(cond)+
    scale_fill_manual(values = so@misc$cluster_cols)+
    theme_bw()+
    coord_flip()+
    scale_x_discrete(limits = rev(levels(celltype_df_f[[cond]]$cell_type))))
}
```

```{r singleR_cl_df_fr_prep, echo=F}
celltype_df_fr <- list()
for (cond in conditions) {
  celltype_df_fr[[cond]] <- as.data.frame(round(prop.table(table(
        cond_subset[[cond]]$pruned.labels_singleR_fine.mod,
        cond_subset[[cond]]@meta.data[[g.b]]),
          margin = 2)*100, digits = 2))
  colnames(celltype_df_fr[[cond]]) <- c("cell_type", "cluster_id", "percentage")
  # remove sample which are not in the current condition
  celltype_df_fr[[cond]] <- celltype_df_fr[[cond]][celltype_df_fr[[cond]]$cluster_id %in% unique(cond_subset[[cond]]@meta.data[[g.b]]),]
  celltype_df_fr[[cond]]$cluster_id <- factor(celltype_df_fr[[cond]]$cluster_id)
}
```

```{r singleR_cl_df_fr_plots, fig.width=12, fig.height=5, echo=F}
for (cond in conditions) {
  print(ggplot(celltype_df_fr[[cond]], aes(x = cluster_id, y = percentage))+
    geom_bar(stat = "identity", aes(fill = cell_type))+
    ggtitle(cond)+
    scale_fill_manual(values = so@misc$fctype_mod_cols)+
    theme_bw()+
    coord_flip()+
    scale_x_discrete(limits = rev(levels(celltype_df_fr[[cond]]$cluster_id)))) +
    theme(
      plot.margin = margin(t = 50, r = 120, b = 50, l = 10)
    )
}
```

## SingleR vs Phase

```{r singleR_phase_tab1, results="asis", echo=F}
for (cond in conditions) {
  cat(paste0("*Condition: ", cond, "*\n\n"))
  print(knitr::kable(as.data.frame.matrix(
          table(cond_subset[[cond]]$Phase,
                cond_subset[[cond]]$pruned.labels_singleR_fine.mod))))
  cat("\n\n")
}
```

```{r singleR_phase_tab2, results="asis", echo=F}
for (cond in conditions) {
  cat(paste0("*Condition: ", cond, "*\n\n"))
  print(knitr::kable(as.data.frame.matrix(addmargins(round(prop.table(table(cond_subset[[cond]]$Phase,
          cond_subset[[cond]]$pruned.labels_singleR_fine.mod), margin = 1)*100, digits = 2), margin = 2))))
  cat("\n\n")
}
```

```{r singleR_phase_tab3, results="asis", echo=F}
for (cond in conditions) {
  cat(paste0("*Condition: ", cond, "*\n\n"))
  print(knitr::kable(as.data.frame.matrix(addmargins(round(prop.table(table(
          cond_subset[[cond]]$pruned.labels_singleR_fine.mod,
          cond_subset[[cond]]$Phase), margin = 1)*100, digits = 2), margin = 2))))
  cat("\n\n")
}
```

```{r singleR_phase_df_prep, echo=F}
celltype_df_f <- list()
for (cond in conditions) {
  celltype_df_f[[cond]] <- as.data.frame(round(prop.table(table(cond_subset[[cond]]$Phase,
                                                              cond_subset[[cond]]$pruned.labels_singleR_fine.mod),
                                                        margin = 2)*100, digits = 2))
  colnames(celltype_df_f[[cond]]) <- c("phase", "cell_type", "percentage")
  # remove cluster which are not in the current condition
  celltype_df_f[[cond]] <- celltype_df_f[[cond]][celltype_df_f[[cond]]$phase %in% unique(cond_subset[[cond]]$Phase),]
  celltype_df_f[[cond]]$phase <- factor(celltype_df_f[[cond]]$phase)
}
```

```{r singleR_phase_df_plots, fig.width=12, fig.height=6, echo=F}
for (cond in conditions) {
  print(ggplot(celltype_df_f[[cond]], aes(x = cell_type, y = percentage))+
    geom_bar(stat = "identity", aes(fill = phase))+
    ggtitle(cond)+
    scale_fill_manual(values = so@misc$phase_cols)+
    theme_bw()+
    coord_flip()+
    scale_x_discrete(limits = rev(levels(celltype_df_f[[cond]]$cell_type))))
}
```

```{r singleR_phase_df_fr_prep, echo=F}
celltype_df_fr <- list()
for (cond in conditions) {
  celltype_df_fr[[cond]] <- as.data.frame(round(prop.table(table(
        cond_subset[[cond]]$pruned.labels_singleR_fine.mod,
        cond_subset[[cond]]$Phase),
          margin = 2)*100, digits = 2))
  colnames(celltype_df_fr[[cond]]) <- c("cell_type", "phase", "percentage")
  # remove sample which are not in the current condition
  celltype_df_fr[[cond]] <- celltype_df_fr[[cond]][celltype_df_fr[[cond]]$phase %in% unique(cond_subset[[cond]]$Phase),]
  celltype_df_fr[[cond]]$phase <- factor(celltype_df_fr[[cond]]$phase)
}
```

```{r singleR_phase_df_fr_plots, fig.width=12, fig.height=5, echo=F}
for (cond in conditions) {
  print(ggplot(celltype_df_fr[[cond]], aes(x = phase, y = percentage))+
    geom_bar(stat = "identity", aes(fill = cell_type))+
    ggtitle(cond)+
    scale_fill_manual(values = so@misc$fctype_mod_cols)+
    theme_bw()+
    coord_flip()+
    scale_x_discrete(limits = rev(levels(celltype_df_fr[[cond]]$phase)))) +
    theme(
      plot.margin = margin(t = 50, r = 120, b = 50, l = 10)
    )
}
```

```{r, fig.width=12, fig.height=12}
params.minrowsum = 100
rs <- Matrix::rowSums(so@assays$RNA@counts)
table(rs>=params.minrowsum)
selgenes <- rownames(so)[rs>params.minrowsum]
TCRgenes <- grep(pattern = "^TR[AB][VC]", selgenes, value = TRUE)
Ig_genes <- c(grep(pattern = "^IG[HLK][VDJ]", selgenes, value = TRUE),
               c("IGHG1", "IGHD", "IGHE", "IGHA[12]", "IGHG[1234]", "IGKC", "IGLC[1234567]", "AC233755.1"))
MTgenes <- grep(pattern = "^MT-", selgenes, value = TRUE)
RiboGenes <- grep(pattern = "^RP[LS]", selgenes, value = TRUE)
selgenes <- selgenes[!selgenes %in% c(TCRgenes, Ig_genes, MTgenes, RiboGenes)]
selgenes <- selgenes[-which(selgenes=="MALAT1")]
```

```{r}
pseudo <- AggregateExpression(so,
                              assays = "RNA",
                              return.seurat = TRUE,
                              group.by = c("clinical_condition", "sample",
                                           "pruned.labels_singleR_fine.mod"))
pseudo$celltype.cond <- paste0(pseudo$pruned.labels_singleR_fine.mod,
                               "_", pseudo$clinical_condition)
Idents(pseudo) <- "celltype.cond"

bulk.de <- list()
for (celltype in unique(pseudo$pruned.labels_singleR_fine.mod)) {
    ident.1 <- paste0(celltype, "_" , "Subclinical")
    ident.2 <- paste0(celltype, "_" , "Hospitalized")
    markers <- FindMarkers(pseudo, features = selgenes,
                ident.1 = ident.1, ident.2 = ident.2, test.use = "DESeq2")
    bulk.de[[celltype]] <- markers
}
```

```{r}
signif_genes <- list()
for (celltype in names(bulk.de)) {
    markers <- bulk.de[[celltype]]
    signif_markers <- markers[markers$p_val_adj <= 0.05, ]
    signif_markers <- na.omit(signif_markers)
    signif_genes[[celltype]] <- signif_markers
}
all_signif_genes <- unique(unlist(lapply(signif_genes, rownames)))

```

```{r}
hospitalized <- subset(so, subset = clinical_condition == "Hospitalized")
subclinical <- subset(so, subset = clinical_condition == "Subclinical")
Idents(hospitalized) <- hospitalized$pruned.labels_singleR_fine
Idents(subclinical) <- subclinical$pruned.labels_singleR_fine

# Identify markers for each cell type in the Hospitalized condition
hospitalized_markers <- FindAllMarkers(hospitalized,  min.pct = 0.25, logfc.threshold = 0.25, features = selgenes)

# Identify markers for each cell type in the Subclinical condition
subclinical_markers <- FindAllMarkers(subclinical, min.pct = 0.25, logfc.threshold = 0.25, features = selgenes)
top_hospitalized_markers <- hospitalized_markers %>% group_by(cluster) %>% top_n(n = 5, wt = avg_log2FC)
top_subclinical_markers <- subclinical_markers %>% group_by(cluster) %>% top_n(n = 5, wt = avg_log2FC)
```

```{r, fig.height=16, fig.width=6}

#hospitalized_data <- hospitalized@assays$RNA@data[unique(top_hospitalized_markers$gene), ]
#pheatmap(hospitalized_data)
DoHeatmap(subclinical, features=c(top_hospitalized_markers$gene, top_subclinical_markers$gene),
          slot="scale.data", assay="RNA") + scale_fill_gradient2(low="blue", mid="white",high="red")
```

```{r, fig.height=8, fig.width=12}
sel <- WhichCells(subclinical, downsample=300)
sub <- subset(subclinical, cells=sel)
DoHeatmap(sub, features=all_signif_genes,
          slot="scale.data", assay="RNA",
            size = 3,          # Adjust the text size
  angle = 90        # Rotate the text to vertical

          ) +
  scale_fill_gradient2(low="blue", mid="white",high="red")  + theme(
  axis.text.y = element_text(size = 8, angle = 0, hjust = 1)
)
```

```{r, fig.height=8, fig.width=12}
sel <- WhichCells(hospitalized, downsample=300)
sub <- subset(hospitalized, cells=sel)
#sel_features=c(top_hospitalized_markers$gene, top_subclinical_markers$gene)
sel_features=all_signif_genes
DoHeatmap(sub, features=all_signif_genes,
          slot="scale.data", assay="RNA",
            size = 3,          # Adjust the text size
  angle = 90        # Rotate the text to vertical

          ) +
  scale_fill_gradient2(low="blue", mid="white",high="red")  + theme(
  axis.text.y = element_text(size = 8, angle = 0, hjust = 1)
)
```

```{r, fig.height=8, fig.width=12}
so$celltype.cond <- paste0(so$pruned.labels_singleR_fine.mod,
                               " - ", so$clinical_condition)
so$celltype.cond <- factor(so$celltype.cond,
      levels = c(
        "Th17 cells - Subclinical",
        "Th17 cells - Hospitalized",
        "Th2 cells - Subclinical",
        "Th2 cells - Hospitalized",
        "Th1 cells - Subclinical",
        "Th1 cells - Hospitalized",
        "Th1/Th17 cells - Subclinical",
        "Th1/Th17 cells - Hospitalized",
        "Naive CD4 T cells - Subclinical",
        "Naive CD4 T cells - Hospitalized",
        "T regulatory cells - Subclinical",
        "T regulatory cells - Hospitalized",
        "Follicular helper T cells - Subclinical",
        "Follicular helper T cells - Hospitalized",
        "Terminal effector CD4 T cells - Subclinical",
        "Terminal effector CD4 T cells - Hospitalized",
        "Naive CD8 T cells - Subclinical",
        "Naive CD8 T cells - Hospitalized",
        "Central memory CD8 T cells - Subclinical",
        "Central memory CD8 T cells - Hospitalized",
        "Terminal effector CD8 T cells - Subclinical",
        "Terminal effector CD8 T cells - Hospitalized",
        "Proliferating effector memory CD8 T cells - Subclinical",
        "Proliferating effector memory CD8 T cells - Hospitalized",
        "Non-proliferating effector memory CD8 T cells - Subclinical",
        "Non-proliferating effector memory CD8 T cells - Hospitalized",
        "Vd2 gd T cells - Subclinical",
        "Vd2 gd T cells - Hospitalized",
        "Non-Vd2 gd T cells - Subclinical",
        "Non-Vd2 gd T cells - Hospitalized",
        "MAIT cells - Subclinical",
        "MAIT cells - Hospitalized"
      ))

Idents(so) <- "celltype.cond"

sel <- WhichCells(so, downsample=500)
sub <- subset(so, cells=sel)

DoHeatmap(sub, features=all_signif_genes,
          group.colors = rep(c("darkgreen", "darkred"), 30),
          slot="counts", assay="RNA",
            size = 3,          # Adjust the text size
  angle = 90        # Rotate the text to vertical

          ) +
  scale_fill_gradient2(low="blue", mid="#EEFFFF",high="red")  + theme(
  axis.text.y = element_text(size = 8, angle = 0, hjust = 1)
) + guides(color="none")
```


```{r, fig.height=12}
subclinical_data <- subclinical@assays$RNA@data[unique(top_subclinical_markers$gene), ]
pheatmap(subclinical_data)
```

```{r, fig.height=18, fig.width=6, eval=F}


# Extract expression data for the markers
hospitalized_data <- hospitalized@assays$RNA@data[unique(top_hospitalized_markers$gene), ]
subclinical_data <- subclinical@assays$RNA@data[unique(top_subclinical_markers$gene), ]

# Create a data frame and convert to tibble for tidyHeatmap
hospitalized_df <- as.data.frame(as.matrix(hospitalized_data))
hospitalized_df$gene <- rownames(hospitalized_df)
hospitalized_df <- hospitalized_df %>% pivot_longer(cols = -gene, names_to = "sample", values_to = "expression") %>% as_tibble()

subclinical_df <- as.data.frame(as.matrix(subclinical_data))
subclinical_df$gene <- rownames(subclinical_df)
subclinical_df <- subclinical_df %>% pivot_longer(cols = -gene, names_to = "sample", values_to = "expression") %>% as_tibble()

# Create heatmap for the Hospitalized condition
hospitalized_heatmap <- hospitalized_df %>%
  heatmap(.row = gene, .column = sample, .value = expression)# +
#  scale_fill_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0)

# Create heatmap for the subclinical condition
subclinical_heatmap <- subclinical_df %>%
  heatmap(.row = gene, .column = sample, .value = expression) #+
#  scale_fill_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0)

# Print the heatmaps
print(hospitalized_heatmap)
print(subclinical_heatmap)
```


# Session info

```{r session_info, echo=FALSE}
sessionInfo()
```
