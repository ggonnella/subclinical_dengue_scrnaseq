---
title: "InDen T cells | Individual samples | SO creation and QC"
author: "Giorgio Gonnella; Sebastien Mella"
date: "2024-03-27"
output:
  html_document: default
params:
  pfx: "/srv/baia/"
  libpath: "/home/giorgio/R-pkg-Seurat5/"
  sample: NA
---

```{r setup, echo=FALSE, include=FALSE}
knitr::opts_chunk$set(message=F, warning=F, echo=F)
.libPaths(c(params$libpath, .libPaths()))

library(Seurat)
library(ggplot2)
library(ggExtra)
library(grid)
library(scater)
library(gplots)
library(DT)
library(ggbeeswarm)
library(parallel)
library(robustbase)
library(viridis)

if (is.na(params$sample)) {
  stop("Please provide a sample name")
}

prj_root <- paste0(params$pfx, "inden/")
analysis_root <- paste0(prj_root, "analysis-1/")

input_step_dir <- paste0(analysis_root, "steps/001.0.P.T.create_seurat_obj/")
input_var_dir <- paste0(input_step_dir, "results/vars/")
if (!dir.exists(input_var_dir)) {
  stop("Input variable directory does not exist: ", input_var_dir)
}

this_step_dir <- paste0(analysis_root, "steps/002.0.P.T.qc_filter/")
if (!dir.exists(this_step_dir)) {
  stop("Current step directory does not exist: ", this_step_dir)
}

var_dir <- paste0(this_step_dir, "results/vars/")
dir.create(var_dir, showWarnings = F, recursive = T)

helpers_dir <- paste0(prj_root, "helpers/")
source(paste0(helpers_dir, "qc_helpers.R"))
```

# Load Seurat object

```{r load_so}
so <- readRDS(paste0(input_var_dir, params$sample, "_so_initial.rds"))
```

# Filtering

## Filter by nGenes, nUMIs and percent.mito

```{r set_min_nGenes_thresholds}
if (params$sample %in% c("sample_1_T", "sample_2_T", "sample_3_T", "sample_4_T",
                         "sample_5_T", "sample_10_T", "sample_13_T")) {
  min_nGenes <- 500
} else if (params$sample %in% c("sample_6_T", "sample_7_T", "sample_8_T",
                                "sample_9_T", "sample_11_T", "sample_12_T")) {
  min_nGenes <- ceiling(attr(so@meta.data$qc.nexprs.low, "thresholds")["lower"])
} else { # "sample_14_T"
  min_nGenes <- min(so$nFeature_RNA)
}
```

```{r set_max_nGenes_thresholds}
if (params$sample %in% c("sample_1_T", "sample_2_T", "sample_3_T", "sample_4_T",
                         "sample_10_T", "sample_13_T", "sample_6_T",
                         "sample_7_T", "sample_8_T", "sample_9_T",
                         "sample_11_T", "sample_12_T")) {
  max_nGenes <- 4000
} else if (params$sample %in% c("sample_5_T")) {
  max_nGenes <- 6500
} else { # "sample_14_T"
  max_nGenes <- max(so$nFeature_RNA)
}
```

```{r set_nUMI_thresholds}
if (params$sample %in% c("sample_14_T")) {
  min_nUMI <- min(so$nCount_RNA)
  max_nUMI <- max(so$nCount_RNA)
} else if (params$sample %in% c("sample_6_T")){
  min_nUMI <- 1000
  max_nUMI <- 50000
} else {
  min_nUMI <- 1000
  max_nUMI <- 20000
}
```

```{r set_max_pmito_threshold}
max_pmito <- 0.1
```

```{r subset1_nGenes_nUMIs_based}
so <- subset(so, subset = nCount_RNA > min_nUMI & nCount_RNA < max_nUMI &
             nFeature_RNA > min_nGenes & nFeature_RNA < max_nGenes &
             percent.mito <= max_pmito)
so$percent.mito.cl <- droplevels(so$percent.mito.cl)
```

## Filter by CD3 / CD8 positivity

```{r}
mat_exp <- as.data.frame(t(as.matrix(so@assays$RNA$counts)))
bctokeep <- rownames(mat_exp)[!(mat_exp$CD3E > 0 |
                                mat_exp$CD3D > 0 |
                                mat_exp$CD3G > 0 |
                                mat_exp$CD8A > 0 |
                                mat_exp$CD8B > 0)]
so <- subset(so, cells = bctokeep)
```

## Filter by VDJ availability

```{r}
use_vdj_filter_samples =
  c("sample_1_T", "sample_6_T", "sample_7_T", "sample_8_T",
    "sample_9_T", "sample_11_T", "sample_12_T")

if (params$sample %in% use_vdj_filter_samples) {
  so <- subset(so, subset = has_prod_vdj == TRUE)
}
```

## Filter multi-outliers

```{r subset outlier}
keep_outliers_samples = c("sample_3_T", "sample_5_T", "sample_14_T")

if (! params$sample %in% keep_outliers_samples) {
  so <- subset(so, subset = multi.outlier == FALSE)
}
```

# Saving

```{r saving, echo=T}
saveRDS(so, paste0(var_dir, params$sample, "_so_filtered.rds"))
```

# Session info

```{r session_info, echo=F}
sessionInfo()
```
