---
title: "InDen B cells | Merging individual samples to a single Seurat object"
author: "Giorgio Gonnella"
date: 2024-04-29
output: html_document
params:
  pfx: "/srv/baia/"
  libpath: "/home/giorgio/R-pkg-Seurat5/"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message=F, warning=F, echo=F)
.libPaths(c(params$libpath, .libPaths()))

library(Seurat)

prj_root <- paste0(params$pfx, "inden/")
analysis_root <- paste0(prj_root, "analysis-1/")

# TODO: change this, integrating the steps before 006 to the analysis
input_var_dir_prevanalysis1 <- paste0(prj_root, "data/bcells1/")
input_var_dir_prevanalysis2 <- paste0(prj_root, "data/bcells2/")
if (!dir.exists(input_var_dir_prevanalysis1)) {
  stop("Input variable directory does not exist: ", input_var_dir_prevanalysis1)
}
if (!dir.exists(input_var_dir_prevanalysis2)) {
  stop("Input variable directory does not exist: ", input_var_dir_prevanalysis2)
}

this_step_dir <- paste0(analysis_root, "steps/106.0.P.B.merging.seurat/")
if (!dir.exists(this_step_dir)) {
  stop("Current step directory does not exist: ", this_step_dir)
}
var_dir <- paste0(this_step_dir, "results/vars/")
dir.create(var_dir, showWarnings = FALSE, recursive = TRUE)

helpers_dir <- paste0(prj_root, "helpers/")
source(paste0(helpers_dir, "helpers.R"))
source(paste0(helpers_dir, "factor_resolution.R"))
```

In the merging step, the individual samples are merged into a single
Seurat object. The UMAP, PCA, and clustering are performed on the merged
object.

## Importing the Seurat objects

The files are imported as a list of Seurat objects.

```{r importing, echo=TRUE}
bcells_files1 <-
  list.files(path = input_var_dir_prevanalysis1, pattern = "_Bcells.Rdata")
bcells_ls1 <- sapply(bcells_files1,
            function(x) mget(load(paste0(input_var_dir_prevanalysis1, x))))
bcells_files2 <- list.files(path = input_var_dir_prevanalysis2, pattern = "_bcells.Rdata")
bcells_ls2 <-
  sapply(bcells_files2, function(x) mget(load(paste0(input_var_dir_prevanalysis2, x))))
bcells_ls <- c(bcells_ls1, bcells_ls2)
rm(list = (c("bcells_files1", "bcells_files2", "bcells_ls1", "bcells_ls2")))
names(bcells_ls) <- sapply(bcells_ls, function(x) x$orig.ident[[1]])
```

## Filtering

Sample 10 is removed because of the low number of cells.

```{r datasets_filtering}
exclude <- c("TC_SC03_S10B_so")
keep <- setdiff(names(bcells_ls), exclude)
bcells_ls <- bcells_ls[keep]
```

## Pre-processing

The analysis (SCT, PCA, UMAP) is removed from the Seurat objects to avoid
confusion after the merging. Without this step, the merging function fails.

```{r remove_info}
bcells_ls <- lapply(bcells_ls, remove_info)
```

## Merging

The Seurat objects for the individual samples are merged
into one Seurat object, using the `merge()` function.

```{r merging, echo=TRUE}
so <- merge(x = bcells_ls[[1]], y = bcells_ls[-1], project = "so")
rm(list = (c("bcells_ls")))
```

The samples in the merged object are ordered by sample number.

```{r sample_ordering, echo=TRUE}
so$orig.ident[
      so$orig.ident == "sample_15_B_so"] <- "TC_SC03_S15B_so"
so$orig.ident[
      so$orig.ident == "sample_16_B_so"] <- "TC_SC03_S16B_so"
so$orig.ident <- factor(so$orig.ident, levels = c("TC_SC03_S1B_so",
                                                  "TC_SC03_S5B_so",
                                                  "TC_SC03_S6B_so",
                                                  "TC_SC03_S7B_so",
                                                  "TC_SC03_S8B_so",
                                                  "TC_SC03_S9B_so",
                                                  "TC_SC03_S11B_so",
                                                  "TC_SC03_S12B_so",
                                                  "TC_SC03_S13B_so",
                                                  "TC_SC03_S15B_so",
                                                  "TC_SC03_S16B_so"))
so$sample <- sub(".*(S\\d+B).*", "\\1", so$orig.ident)
```

Add clinical condition metadata.

```{r add_clinical_condition, echo=TRUE}
conditions <- c("Hospitalized", "Subclinical")
hosp_n = c("1", "2", "3", "5", "6", "7", "15", "16")
so$clinical_condition <-
  ifelse(so$orig.ident %in% paste0("TC_SC03_S", hosp_n, "B_so"),
         conditions[1], conditions[2])
```

## Normalization

```{r normalization, echo=TRUE}
so <- NormalizeData(object = so, assay = "RNA")
```

## Selection of highly variable genes

```{r hvg_selection, echo=TRUE}
so <- FindVariableFeatures(object = so, assay = "RNA",
                           nfeatures = 2500, selection.method = "vst")
```

Removing unwanted source of variation in the highly variable genes

```{r genesets, echo=TRUE}
so@misc$genesets$TCR <- grep(pattern = "^TR[AB][VC]", so@assays$RNA@var.features, value = TRUE)
so@misc$genesets$IG <- c(grep(pattern = "^IG[HLK][VDJ]", so@assays$RNA@var.features, value = TRUE),
              c("IGHM", "IGHD", "IGHE", "IGHA[12]", "IGHG[1234]", "IGKC", "IGLC[1234567]", "AC233755.1"))
so@misc$genesets$MT <- grep(pattern = "^MT", so@assays$RNA@var.features, value = TRUE)
so@misc$genesets$Ribo <- grep(pattern = "^RP[LS]", so@assays$RNA@var.features, value = TRUE)
```

```{r unwanted_genes, echo=T}
unwanted_genes <- c(so@misc$genesets$TCR,
                    so@misc$genesets$IG,
                    so@misc$genesets$MT,
                    so@misc$genesets$Ribo)
```

```{r correcting_hvg, echo=TRUE}
hvg_corr <- so@assays$RNA@var.features[
      !so@assays$RNA@var.features %in% unwanted_genes]
```

## Scaling data

```{r scaling, echo=TRUE}
so <- ScaleData(object = so,
            features = so@assays$RNA@var.features,
            vars.to.regress = c("nCount_RNA", "percent.mito"),
            assay = "RNA")
```


## Linear dimension reduction (PCA)

```{r pca, echo=TRUE}
so <- RunPCA(object = so, features = hvg_corr,
             npcs = 50, assay = "RNA")
```

## Non-linear dim reduction (UMAP)

```{r umap, echo=TRUE}
myDims <- 1:40
so <- RunUMAP(object = so, dims = myDims,
              reduction = "pca", reduction.name = "umap")
```

## Clustering

```{r clustering, echo=TRUE}
reS <- c(0.2, 0.4, 0.6, 0.8, 1.0, 1.2)
so <- FindNeighbors(object = so, dims = myDims)
so <- FindClusters(object = so, resolution = reS)
so <- factor_resolution(so)
```

## Saving Data

```{r saving}
saveRDS(so, paste0(var_dir, "merged_so.rds"))
```

## Session Info

```{r session_info, echo=FALSE}
sessionInfo()
```
