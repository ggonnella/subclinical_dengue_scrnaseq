---
title: "InDen | T cells | Pseudobulk DE Seurat 5 | Cell types"
author: "Giorgio Gonnella"
date: 2024-06-13
output:
  html_document:
    theme: sandstone
params:
  pfx: "/srv/baia/"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE, comment = FALSE, echo = TRUE)

library(Seurat)
library(dplyr)

prj_root <- paste0(params$pfx, "inden/")
analysis_root <- paste0(prj_root, "analysis-1/")

prev_step_dir <- paste0(analysis_root, "steps/008.0.P.T.split_CD8EM/")
input_var_dir <- paste0(prev_step_dir, "results/vars/")

this_step_dir <- paste0(analysis_root, "steps/009.0.P.T.compute_de/")
results_dir <- paste0(this_step_dir, "results/celltypes_s5/")
dir.create(results_dir, showWarnings = FALSE, recursive = TRUE)
```

```{r load_input_data}
so <- readRDS(file = paste0(input_var_dir, "splitted_CD8EM_so.rds"))

```

```{r select_genes}
selgenes <- rownames(so)
print(paste0("Initial number of genes: ", length(selgenes)))

rs <- Matrix::rowSums(so@assays$RNA@counts)
print(summary(rs))
minrowsum = 0
print(paste0("Minimum row sum parameter: ", minrowsum))
selgenes <- rownames(so)[rs >= minrowsum]
print(paste0("Number of selected genes passing rowsum filter: ", length(selgenes)))

TCRgenes <- grep(pattern = "^TR[ABGD][VC]", selgenes, value = TRUE)
print(paste0("Number of TCR genes to filter out: ", length(TCRgenes)))
Ig_genes <- c(grep(pattern = "^IG[HLK][VDJ]", selgenes, value = TRUE),
               c("IGHG1", "IGHD", "IGHE", "IGHA[12]", "IGHG[1234]", "IGKC", "IGLC[1234567]", "AC233755.1"))
print(paste0("Number of IG genes to filter out: ", length(Ig_genes)))
MTgenes <- grep(pattern = "^MT-", selgenes, value = TRUE)
print(paste0("Number of Mitochondrial genes to filter out: ", length(MTgenes)))
RiboGenes <- grep(pattern = "^RP[LS]", selgenes, value = TRUE)
print(paste0("Number of Ribosomal genes to filter out: ", length(RiboGenes)))
MoreGenesToFilter <- c("MALAT1")
print(paste0("Further genes to filter out: ", MoreGenesToFilter))
GenesToFilter = c(TCRgenes, Ig_genes, MTgenes, RiboGenes, MoreGenesToFilter)
print(paste0("Total number of genes to filter out: ", length(GenesToFilter)))

selgenes <- selgenes[!selgenes %in% GenesToFilter]
print(paste0("Final number of selected genes: ", length(selgenes)))
```

```{r aggregate_expression}
clusters_col <- "pruned.labels_singleR_fine.mod"
group_by = c("clinical_condition", "sample", clusters_col)
pseudo <- AggregateExpression(so,
                              assays = "RNA",
                              return.seurat = TRUE,
                              group.by = group_by)
```

```{r create_pseudobulk_identities}
clusters_data <- pseudo@meta.data[[clusters_col]]
pseudo$cond.clusters <- paste0(pseudo$clinical_condition, "_", clusters_data)
Idents(pseudo) <- "cond.clusters"
cluster_names <- unique(clusters_data)
```

```{r run_de}
all.de <- list()
pval_filt.de <- list()
tests_to_try = c("DESeq2")

freqs = table(Idents(pseudo))

for (cluster in cluster_names) {
  all.de[[cluster]] <- list()
  pval_filt.de[[cluster]] <- list()
  for (test_name in tests_to_try) {
      ident.1 <- paste0("Mild_", cluster)
      ident.2 <- paste0("Hospitalized_", cluster)
      if ((ident.1 %in% Idents(pseudo)) && (ident.2 %in% Idents(pseudo))
          && (freqs[[ident.1]] > 3) && (freqs[[ident.2]] > 3)) {
        print(paste0("Computing ", test_name, " for ", ident.1, " vs ", ident.2, "..."))
        markers <- FindMarkers(pseudo, features = selgenes, logfc.threshold = 0.1,
                    ident.1 = ident.1, ident.2 = ident.2, test.use = test_name)
        all.de[[cluster]][[test_name]] <- markers
        pval_filt.de[[cluster]][[test_name]] <- markers %>% filter(p_val_adj < 0.05)
        print(paste0("  Number of genes with adj p-value < 0.05: ", nrow(pval_filt.de[[cluster]][[test_name]])))
      }
  }
}
```

```{r add_unsplitted_CD8EM_cells}
clusters_col2 = "pruned.labels_singleR_fine"
group_by = c("clinical_condition", "sample", clusters_col2)
pseudo2 <- AggregateExpression(so,
                              assays = "RNA",
                              return.seurat = TRUE,
                              group.by = group_by)
clusters_data2 <- pseudo2@meta.data[[clusters_col2]]
pseudo2$cond.clusters <- paste0(pseudo2$clinical_condition, "_", clusters_data2)

Idents(pseudo2) <- "cond.clusters"
freqs2 = table(Idents(pseudo2))

cluster = "Effector memory CD8 T cells"
pval_filt.de[[cluster]] <- list()
for (test_name in tests_to_try) {
      ident.1 <- paste0("Mild_", cluster)
      ident.2 <- paste0("Hospitalized_", cluster)
      if ((ident.1 %in% Idents(pseudo2)) && (ident.2 %in% Idents(pseudo2))
          && (freqs2[[ident.1]] > 3) && (freqs2[[ident.2]] > 3)) {
        print(paste0("Computing ", test_name, " for ", ident.1, " vs ", ident.2, "..."))
        markers <- FindMarkers(pseudo2, features = selgenes, logfc.threshold = 0.1,
                    ident.1 = ident.1, ident.2 = ident.2, test.use = test_name)
        all.de[[cluster]][[test_name]] <- markers
        pval_filt.de[[cluster]][[test_name]] <- markers %>% filter(p_val_adj < 0.05)
        print(paste0("  Number of genes with adj p-value < 0.05: ", nrow(pval_filt.de[[cluster]][[test_name]])))
      }
}
```

```{r add_total_cells}
group_by = c("clinical_condition", "sample")
pseudo3 <- AggregateExpression(so,
                              assays = "RNA",
                              return.seurat = TRUE,
                              group.by = group_by)
Idents(pseudo3) <- "clinical_condition"
freqs3 = table(Idents(pseudo3))

cluster = "Total"
pval_filt.de[[cluster]] <- list()
for (test_name in tests_to_try) {
      ident.1 <- "Mild"
      ident.2 <- "Hospitalized"
      if ((ident.1 %in% Idents(pseudo3)) && (ident.2 %in% Idents(pseudo3))
          && (freqs3[[ident.1]] > 3) && (freqs3[[ident.2]] > 3)) {
        print(paste0("Computing ", test_name, " for ", ident.1, " vs ", ident.2, "..."))
        markers <- FindMarkers(pseudo3, features = selgenes, logfc.threshold = 0.1,
                    ident.1 = ident.1, ident.2 = ident.2, test.use = test_name)
        all.de[[cluster]][[test_name]] <- markers
        pval_filt.de[[cluster]][[test_name]] <- markers %>% filter(p_val_adj < 0.05)
        print(paste0("  Number of genes with adj p-value < 0.05: ", nrow(pval_filt.de[[cluster]][[test_name]])))
      }
}
```

```{r save_results}
fname <- paste0(results_dir, "pval_filt.de.tsv")
cat("cluster\tgene\tperc.1\tperc.2\tp_val\tp_val_adj\tlog2fc\n", file = fname)
for (cluster in c(cluster_names, "Effector memory CD8 T cells", "Total")) {
  for (test_name in tests_to_try) {
    for (gene in rownames(pval_filt.de[[cluster]][[test_name]])) {
        cat(cluster, "\t", gene, "\t",
            pval_filt.de[[cluster]][[test_name]][gene, ]$pct.1, "\t",
            pval_filt.de[[cluster]][[test_name]][gene, ]$pct.2, "\t",
            pval_filt.de[[cluster]][[test_name]][gene, ]$p_val, "\t",
            pval_filt.de[[cluster]][[test_name]][gene, ]$p_val_adj, "\t",
            pval_filt.de[[cluster]][[test_name]][gene, ]$avg_log2FC, "\n",
            file = fname, append = TRUE)
    }
    cluster_name_sanitized = gsub(" ", "_", cluster)
    cluster_name_sanitized = gsub("/", "_", cluster_name_sanitized)
    fname_all <- paste0(results_dir, "all_genes.", cluster_name_sanitized,
                        ".", test_name, ".de.tsv")
    data <- all.de[[cluster]][[test_name]]
    data$gene <- rownames(data)
    data <- data[, c(ncol(data), 1:(ncol(data) - 1))]
    write.table(data,, file = fname_all, sep = "\t", quote = F, row.names = F)
  }
}
```

# Session info

```{r}
sessionInfo()
```

