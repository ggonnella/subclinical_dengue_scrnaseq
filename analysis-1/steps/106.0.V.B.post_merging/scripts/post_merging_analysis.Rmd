---
title: "InDen Project | B cells | Data visualization after merging"
author: "Giorgio Gonnella"
date: 2024-04-29
output:
  html_document:
    theme: sandstone
params:
  pfx: "/srv/baia/"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE, comment = FALSE, echo = TRUE)

library(Seurat)
library(viridis)
library(ggplot2)
library(ggrepel)
library(ggExtra)
library(gplots)
library(RColorBrewer)
library(reshape2)
library(ggsci)
library(dplyr)
library(mclust)

prj_root <- paste0(params$pfx, "inden/")
analysis_root <- paste0(prj_root, "analysis-1/")

input_step_dir <- paste0(analysis_root, "steps/106.0.P.B.merging.seurat/")
var_dir <- paste0(input_step_dir, "results/vars/")
```

```{r load, echo=F}
so <- readRDS(paste0(var_dir, "merged_so.rds"))
sample_cols <- colorRampPalette(brewer.pal(8, name = "Accent"))(
                  length(unique(so$orig.ident)))
```

## PCA

### Genes in PCs

```{r pc_genes, echo=FALSE}
print(x = so[["pca"]], dims = 1:5, nfeatures = 20)
```

### PCA Biplot

```{r pca_biplot, fig.align="center", fig.width=8, fig.height=4, echo=FALSE}
DimPlot(object = so, reduction = "pca", group.by = "orig.ident",
        cols = sample_cols)
```

```{r pca_biplot_by_sample, fig.width=12,fig.height=12, echo=FALSE, fig.align="center"}
DimPlot(object = so, reduction = "pca", group.by = "orig.ident",
        split.by = "orig.ident", cols = sample_cols, ncol = 3) + NoLegend() +
        geom_hline(yintercept = 0, linetype= "dashed", color = "orange1") +
        geom_vline(xintercept = 0, linetype="dashed", color = "orange1")
```

### Elbow plot

```{r elbow_plot, fig.align="center", echo=FALSE}
ElbowPlot(object = so, ndims = 50)
```

## UMAP

### Overall UMAP plot

```{r umap, fig.align="center", fig.width=12, fig.height=6, echo=F}
DimPlot(object = so, reduction = "umap",
        group.by = "orig.ident", cols = sample_cols)
```

### UMAP plots by sample

```{r umap_by_sample, fig.align="center", fig.width=12, fig.height=12, echo=F}
DimPlot(object = so, reduction = "umap", group.by = "orig.ident",
        cols = sample_cols, split.by = "orig.ident", ncol = 3) + NoLegend() +
      geom_hline(yintercept = 0, linetype= "dashed", color = "orange1") +
      geom_vline(xintercept = 0, linetype="dashed", color = "orange1")
```

### Basic metrics

Basic metrics projected onto the UMAP space

```{r umap_basic_metrics, fig.align="center", echo=F}
FeaturePlot(so, reduction = "umap",
            features = "nCount_RNA") + scale_color_viridis()
FeaturePlot(so, reduction = "umap",
            features = "nFeature_RNA") + scale_color_viridis(option = "inferno")
FeaturePlot(so, reduction = "umap",
            features = "percent.mito") + scale_color_viridis(option = "magma")
DimPlot(object = so, reduction = "umap", group.by = "Phase",
            cols = c("#00AFBB", "#E7B800", "#FC4E07"))
```

## Clustering

Selected cluster resolution: 0.4
```{r selected_clustering_resolution, echo=F}
sel_res <- "0.4"
g.b = paste0("RNA_snn_res.", sel_res)
cl_cols <- colorRampPalette(brewer.pal(9, name = "Set1"))(
              length(unique(so@meta.data[[g.b]])))
```

```{r umap_clustering, fig.align="center", fig.width=12, fig.height=6, echo=F}
print(DimPlot(object = so, reduction = "umap",
        group.by = g.b, label = TRUE, cols = cl_cols))
print(VlnPlot(object = so, features = c("nCount_RNA",
       "nFeature_RNA", "percent.mito"), group.by = g.b, cols = cl_cols))
sample_vs_cl <- as.data.frame(
  round(prop.table(table(so@meta.data[[g.b]],
                         so$orig.ident), margin = 1)*100,
        digits = 2)
)
colnames(sample_vs_cl)[1:2] <- c("Seurat_Cl", "Sampleid")
levels(sample_vs_cl$Seurat_Cl) <-
  paste("Cl", levels(sample_vs_cl$Seurat_Cl), sep = "_")
print(ggplot(sample_vs_cl, aes(x = Seurat_Cl, y = Freq, fill = Sampleid))+
  geom_bar(stat = "identity", alpha = .98)+
  coord_flip()+
  theme_minimal()+
  scale_fill_manual(values = sample_cols))
```

## Cell types

SingleR cell type annotations

```{r rename_unchar_to_uncharacterized, echo=F}
so$pruned.labels_singleR_main <- gsub("unchar", "uncharacterized",
                                                     so$pruned.labels_singleR_main)
so$pruned.labels_singleR_fine <- gsub("unchar", "uncharacterized",
                                                     so$pruned.labels_singleR_fine)
```

### Main cell types

```{r umap_singleR_main, fig.width=12, fig.height=6, echo=F}
mctype_col <- colorRampPalette(brewer.pal(6, "Accent"))(length(unique(so$pruned.labels_singleR_main)))
DimPlot(object = so, reduction = "umap", group.by = "pruned.labels_singleR_main", cols = mctype_col, label = TRUE, repel = TRUE)
```

```{r umap_singleR_by_sample_main, fig.width=12, fig.height=12, echo=F}
DimPlot(object = so, reduction = "umap", group.by = "pruned.labels_singleR_main", cols = mctype_col, label = TRUE, repel = TRUE, split.by = "orig.ident", ncol = 3)+NoLegend()+geom_hline(yintercept = 0, linetype = "dashed", color = "orange1")+geom_vline(xintercept = 0, linetype = "dashed", color = "orange1")
```

```{r celltypes_per_sample_table_main, echo=F}
knitr::kable(as.data.frame.matrix(round(prop.table(table(so$orig.ident,
                                                         so$pruned.labels_singleR_main), margin = 2)*100, digits = 2)))
```

```{r celltypes_per_sample_data_main, echo=F}
celltype_df_m <- as.data.frame(round(prop.table(table(so$orig.ident,
                                                    so$pruned.labels_singleR_main), margin = 2)*100, digits = 2))
colnames(celltype_df_m) <- c("sample_id", "cell_type", "percentage")
```

```{r celltypes_per_sample_plot_main, fig.width=12, fig.height=4, echo=F}
ggplot(celltype_df_m, aes(x = cell_type, y = percentage))+
  geom_bar(stat = "identity", aes(fill = sample_id))+
  scale_fill_manual(values = sample_cols)+
  theme_bw()+
  coord_flip()+
  scale_x_discrete(limits = rev(levels(celltype_df_m$cell_type)))
```

```{r samples_per_celltype_table_main, echo=F}
knitr::kable(as.data.frame.matrix(round(prop.table(table(so$pruned.labels_singleR_main,
                                                         so$orig.ident), margin = 2)*100, digits = 2)))
```

```{r samples_per_celltypes_data_main, echo=F}
celltype_df_mr <- as.data.frame(round(prop.table(table(so$pruned.labels_singleR_main,
                                                    so$orig.ident), margin = 2)*100, digits = 2))
colnames(celltype_df_mr) <- c("cell_type", "sample_id", "percentage")
```

```{r samples_per_celltype_plot_main, fig.width=12, fig.height=4, echo=F}
ggplot(celltype_df_mr, aes(x = sample_id, y = percentage))+
  geom_bar(stat = "identity", aes(fill = cell_type))+
  scale_fill_manual(values = mctype_col)+
  theme_bw()+
  coord_flip()+
  scale_x_discrete(limits = rev(levels(celltype_df_mr$sample_id)))
```

### Fine cell types

```{r umap_singleR_fine, fig.width=12, fig.height=6, echo=F}
fctype_col <- colorRampPalette(brewer.pal(6, "Accent"))(length(unique(so$pruned.labels_singleR_fine)))
DimPlot(object = so, reduction = "umap", group.by = "pruned.labels_singleR_fine", cols = fctype_col, label = TRUE, repel = TRUE)
```

```{r umap_singleR_by_sample_fine, fig.width=12, fig.height=12, echo=F}
DimPlot(object = so, reduction = "umap", group.by = "pruned.labels_singleR_fine", cols = fctype_col, label = TRUE, repel = TRUE, split.by = "orig.ident", ncol = 3)+NoLegend()+geom_hline(yintercept = 0, linetype = "dashed", color = "orange1")+geom_vline(xintercept = 0, linetype = "dashed", color = "orange1")
```

```{r celltypes_per_sample_table_fine, echo=F}
knitr::kable(as.data.frame.matrix(round(prop.table(table(so$orig.ident,
                                                         so$pruned.labels_singleR_fine), margin = 2)*100, digits = 2)))
```

```{r celltypes_per_sample_data_fine, echo=F}
celltype_df_f <- as.data.frame(round(prop.table(table(so$orig.ident,
                                                    so$pruned.labels_singleR_fine), margin = 2)*100, digits = 2))
colnames(celltype_df_f) <- c("sample_id", "cell_type", "percentage")
```

```{r celltypes_per_sample_plot_fine, fig.width=12, fig.height=4, echo=F}
ggplot(celltype_df_f, aes(x = cell_type, y = percentage))+
  geom_bar(stat = "identity", aes(fill = sample_id))+
  scale_fill_manual(values = sample_cols)+
  theme_bw()+
  coord_flip()+
  scale_x_discrete(limits = rev(levels(celltype_df_f$cell_type)))
```

```{r samples_per_celltype_table_fine, echo=F}
knitr::kable(as.data.frame.matrix(round(prop.table(table(so$pruned.labels_singleR_fine,
                                                         so$orig.ident), margin = 2)*100, digits = 2)))
```

```{r samples_per_celltypes_data_fine, echo=F}
celltype_df_fr <- as.data.frame(round(prop.table(table(so$pruned.labels_singleR_fine,
                                                    so$orig.ident), margin = 2)*100, digits = 2))
colnames(celltype_df_fr) <- c("cell_type", "sample_id", "percentage")
```

```{r samples_per_celltype_plot_fine, fig.width=12, fig.height=4, echo=F}
ggplot(celltype_df_fr, aes(x = sample_id, y = percentage))+
  geom_bar(stat = "identity", aes(fill = cell_type))+
  scale_fill_manual(values = fctype_col)+
  theme_bw()+
  coord_flip()+
  scale_x_discrete(limits = rev(levels(celltype_df_fr$sample_id)))
```

#### Single cell types

UMAP highlighting single cell types (singleR fine)

```{r single_cell_types_umap, fig.width=12, fig.height=6, echo=F}
for (celltype in unique(so$pruned.labels_singleR_fine)) {
  highl <- WhichCells(so,
                      expression = pruned.labels_singleR_fine == celltype)
  print(DimPlot(so, reduction = "umap",
          cells.highlight = highl, cols.highlight = "darkblue",
          cols = "grey") + ggtitle(celltype) + theme(legend.position = "none"))
}
```

## Cell types by cluster

### Tables

```{r singleR_vs_clustering_tables, fig.width=12, fig.height=6, results="asis", echo=F}
print(knitr::kable(as.data.frame.matrix(table(so@meta.data[[g.b]], so$pruned.labels_singleR_fine))))
print(knitr::kable(as.data.frame.matrix(addmargins(round(prop.table(table(so@meta.data[[g.b]], so$pruned.labels_singleR_fine), margin = 1)*100, digits = 2), margin = 2))))
print(knitr::kable(as.data.frame.matrix(addmargins(round(prop.table(table(so$pruned.labels_singleR_fine, so@meta.data[[g.b]]), margin = 1)*100, digits = 2), margin = 2))))
```

### Plots

```{r singleR_vs_clustering_plots, fig.width=12, fig.height=6, echo=F}
df <- as.data.frame(round(prop.table(table(so@meta.data[[g.b]], so$pruned.labels_singleR_fine), margin = 2)*100, digits = 2))
colnames(df) <- c("cluster", "cell_type", "percentage")
print(ggplot(df, aes(x = cell_type, y = percentage))+
geom_bar(stat = "identity", aes(fill = cluster))+
theme_bw()+
coord_flip()+
scale_x_discrete(limits = rev(levels(df$cell_type))))
df2 <- as.data.frame(round(prop.table(table(so$pruned.labels_singleR_fine, so@meta.data[[g.b]]), margin = 2)*100, digits = 2))
colnames(df2) <- c("cell_type", "cluster", "percentage")
print(ggplot(df2, aes(x = cluster, y = percentage))+
  geom_bar(stat = "identity", aes(fill = cell_type))+
  theme_bw()+
  coord_flip()+
  scale_x_discrete(limits = rev(levels(df2$cluster))))
```

#### Cell phase

Plots comparing cell type assignments divided by cell phase assignment with the unsupervised clustering

```{r singleR_and_phase_vs_clustering_plots, fig.width=12, fig.height=12, echo=F}
df <- as.data.frame(round(prop.table(table(so@meta.data[[g.b]], interaction(so$Phase, so$pruned.labels_singleR_fine)), margin = 2)*100, digits = 2))
colnames(df) <- c("cluster", "phase_cell_type", "percentage")
print(ggplot(df, aes(x = phase_cell_type, y = percentage))+
  geom_bar(stat = "identity", aes(fill = cluster))+
  theme_bw()+
  coord_flip()+
  scale_x_discrete(limits = rev(levels(df$phase_cell_type))))
df2 <- as.data.frame(round(prop.table(table(interaction(so$Phase, so$pruned.labels_singleR_fine), so@meta.data[[g.b]]), margin = 2)*100, digits = 2))
colnames(df2) <- c("phase_cell_type", "cluster", "percentage")
print(ggplot(df2, aes(x = cluster, y = percentage))+
  geom_bar(stat = "identity", aes(fill = phase_cell_type))+
  theme_bw()+
  coord_flip()+
  scale_x_discrete(limits = rev(levels(df2$cluster))))
```

## Session info

```{r, echo=F}
sessionInfo()
```
